<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ficha ‚Äî Sistema Z (Modo Escuro)</title>
<style>
  :root{
    --bg:#07070a;
    --panel:#0f1720;
    --muted:#93a1b1;
    --accent:#ef4444;
    --glass:rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg),#04101a);color:#e7eef8;padding:18px}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;color:var(--accent);font-size:20px}
  .note{color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg,var(--panel),#071022);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 24px rgba(0,0,0,0.5)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:14px}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type=text], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:90px}
  .attrs{display:flex;gap:8px;margin-top:8px}
  .attr{flex:1;background:var(--glass);padding:10px;border-radius:10px;text-align:center}
  .attr .name{font-size:13px;color:var(--muted)}
  .attr .val{font-size:20px;margin:6px 0}
  .attr .controls{display:flex;justify-content:center;gap:8px}
  .btn{background:var(--accent);border:none;color:white;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#2b3946}
  .skills{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  .skill{background:var(--glass);padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:13px;padding:6px 8px}
  .row{display:flex;gap:8px;align-items:center}
  .resultado{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:10px;color:var(--muted)}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üßü Sistema Z ‚Äî Ficha (Modo Escuro)</h1>
      <div class="row">
        <button id="exportBtn" class="btn small">Exportar JSON</button>
        <button id="importBtn" class="btn small secondary">Importar JSON</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div style="flex:1">
          <label>Nome do Personagem</label>
          <input id="nome" type="text" placeholder="Ex: Ana Silva">
        </div>
        <div style="width:260px">
          <label>Origem / Background</label>
          <select id="origem"></select>
        </div>
      </div>
      <div class="note" style="margin-top:10px">
        Atributos come√ßam em <strong>1</strong>. Voc√™ tem <strong id="poolText">5</strong> pontos para distribuir (cada ponto aumenta 1 atributo). Atributos variam de <strong>0</strong> (m√≠nimo) at√© <strong>4</strong> (m√°ximo).
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div>
        <div class="card">
          <label>Atributos</label>
          <div class="attrs" id="attrsBox"></div>
          <div class="row" style="margin-top:10px;justify-content:space-between">
            <div class="note">Pontos restantes: <strong id="pointsLeft">5</strong></div>
            <div class="note">Nota: reduzir de 1 ‚Üí 0 devolve 1 ponto.</div>
          </div>

          <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)">

          <label>Per√≠cias (selecione n√≠vel)</label>
          <div class="skills" id="skillsBox"></div>
          <div class="note" style="margin-top:8px">Treinado = +2, Especialista = +4. Origem aplica b√¥nus automaticamente nas per√≠cias.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>Equipamento</label>
          <textarea id="equip" placeholder="Ex: Pistola (1d8), Faca (1d6)"></textarea>
          <label style="margin-top:8px">Notas</label>
          <textarea id="notes"></textarea>
        </div>
      </div>

      <!-- Right -->
      <div>
        <div class="card">
          <label>Resumo / Visualiza√ß√£o</label>
          <div id="summary" class="resultado">Altere atributos, origem ou per√≠cias para ver os b√¥nus aplicados.</div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="saveLocal" class="btn" style="flex:1">Salvar local</button>
            <button id="loadLocal" class="btn secondary" style="flex:1">Carregar local</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>Per√≠cias afetadas pela origem</label>
          <div id="originEffects" class="note"></div>
        </div>
      </div>
    </div>

    <footer>Observa√ß√£o: atributo determina quantos d20 voc√™ rolaria (pega o maior). Se atributo = 0, rola 2d20 e pega o pior. Origem fornece b√¥nus direto nas per√≠cias (somado ao n√≠vel escolhido).</footer>
  </div>

<script>
/* ========== CONFIG ========== */
const MAX_ATTR = 4;
const MIN_ATTR = 0;
const START_ATTR = 1;
const POINT_POOL = 5;

const ATTR_KEYS = ['forca','agilidade','vigor','intelecto','carisma'];
const ATTR_LABELS = { forca:'For√ßa', agilidade:'Agilidade', vigor:'Vigor', intelecto:'Intelecto', carisma:'Carisma' };

/* skills list */
const SKILLS = [
  { id:'atletismo', label:'Atletismo', attr:'forca' },
  { id:'briga', label:'Briga', attr:'forca' },
  { id:'armasBrancas', label:'Armas Brancas', attr:'forca' },
  { id:'armasFogo', label:'Armas de Fogo', attr:'agilidade' },
  { id:'furtividade', label:'Furtividade', attr:'agilidade' },
  { id:'pontaria', label:'Pontaria', attr:'agilidade' },
  { id:'reflexos', label:'Reflexos', attr:'agilidade' },
  { id:'resistencia', label:'Resist√™ncia', attr:'vigor' },
  { id:'sobrevivencia', label:'Sobreviv√™ncia', attr:'vigor' },
  { id:'medicina', label:'Medicina', attr:'intelecto' },
  { id:'investigacao', label:'Investiga√ß√£o', attr:'intelecto' },
  { id:'engenharia', label:'Engenharia', attr:'intelecto' },
  { id:'persuasao', label:'Persuas√£o', attr:'carisma' },
  { id:'intimidacao', label:'Intimida√ß√£o', attr:'carisma' },
  { id:'empatia', label:'Empatia', attr:'carisma' }
];

/* origins ‚Äî each maps skillId -> bonus (2 or 4) */
const ORIGENS = {
  'nenhuma': {},
  'militar': { 'armasFogo':2, 'reflexos':2 },
  'cientista': { 'investigacao':2, 'medicina':4 },
  'detetive': { 'investigacao':2, 'percepcao':2 }, // percepcao not in list but harmless
  'medico': { 'medicina':4, 'empatia':2 },
  'artista': { 'persuasao':2, 'empatia':2 },
  'criminoso': { 'furtividade':2, 'intimidacao':2 },
  'religioso': { 'empatia':2, 'persuasao':2 },
  'tecnico': { 'engenharia':2, 'armasFogo':2 },
  'explorador': { 'sobrevivencia':2, 'atletismo':2 },
  'academico': { 'investigacao':2, 'engenharia':2 }
};

/* ========== STATE ========== */
let state = {
  name: '',
  origin: 'nenhuma',
  attrs: {},
  skillLevel: {}, // skillId -> 0/2/4 (player chosen)
  equip: '',
  notes: ''
};

/* initialize default attrs = 1 */
function resetStateDefaults(){
  ATTR_KEYS.forEach(k => state.attrs[k] = START_ATTR);
  SKILLS.forEach(s => {
    if(state.skillLevel[s.id] === undefined) state.skillLevel[s.id] = 0;
  });
  state.name = state.name || '';
  state.origin = state.origin || 'nenhuma';
  state.equip = state.equip || '';
  state.notes = state.notes || '';
}
resetStateDefaults();

/* ========== HELPERS ========== */
function calcPoints(){
  // points spent = sum(max(0, attr - START_ATTR))
  // but decreasing below START_ATTR returns points: if attr < START_ATTR, freed = START_ATTR - attr
  const spentAbove = Object.values(state.attrs).filter(v => v > START_ATTR).reduce((a,b)=>a+b-START_ATTR,0);
  const freedBelow = Object.values(state.attrs).filter(v => v < START_ATTR).reduce((a,b)=>a + (START_ATTR - b),0);
  const left = POINT_POOL + freedBelow - spentAbove;
  return Math.max(0, left); // never negative (we prevent illegal moves)
}

function originSkillBonus(skillId){
  const map = ORIGENS[state.origin] || {};
  return map[skillId] || 0;
}

function totalSkillBonus(skillId){
  const chosen = parseInt(state.skillLevel[skillId] || 0,10) || 0;
  return chosen + originSkillBonus(skillId);
}

/* ========== RENDER UI ========== */
const attrsBox = document.getElementById('attrsBox');
const pointsLeftEl = document.getElementById('pointsLeft');
const skillsBox = document.getElementById('skillsBox');
const summaryDiv = document.getElementById('summary');
const origemSelect = document.getElementById('origem');
const originEffects = document.getElementById('originEffects');

function renderOriginOptions(){
  origemSelect.innerHTML = '';
  Object.keys(ORIGENS).forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = (k === 'nenhuma') ? '‚Äî Nenhuma ‚Äî' : `${k.charAt(0).toUpperCase()+k.slice(1)}`;
    origemSelect.appendChild(opt);
  });
  origemSelect.value = state.origin;
}

function renderAttrs(){
  attrsBox.innerHTML = '';
  ATTR_KEYS.forEach(k=>{
    const div = document.createElement('div');
    div.className = 'attr';
    const val = state.attrs[k];
    div.innerHTML = `
      <div class="name">${ATTR_LABELS[k]}</div>
      <div class="val" id="val_${k}">${val}</div>
      <div style="font-size:12px;color:var(--muted)">${val===0 ? 'efeito: 0 (2d20 -> pior)' : 'dados: ' + val + 'd20 (pega maior)'}</div>
      <div class="controls" style="margin-top:8px">
        <button class="btn small" data-act="dec" data-key="${k}">-</button>
        <button class="btn small" data-act="inc" data-key="${k}">+</button>
      </div>
    `;
    attrsBox.appendChild(div);
  });

  // attach handlers
  document.querySelectorAll('button[data-act]').forEach(b=>{
    b.addEventListener('click', ()=> {
      const act = b.dataset.act;
      const key = b.dataset.key;
      if(act === 'inc') incAttr(key);
      else decAttr(key);
    });
  });

  pointsLeftEl.textContent = calcPoints();
}

function renderSkills(){
  skillsBox.innerHTML = '';
  SKILLS.forEach(s=>{
    const chosen = state.skillLevel[s.id] || 0;
    const originBonus = originSkillBonus(s.id);
    const total = chosen + originBonus;
    const div = document.createElement('div');
    div.className = 'skill';
    div.innerHTML = `
      <div style="min-width:55%">
        <b>${s.label}</b>
        <div class="note" style="font-size:12px">${ATTR_LABELS[s.attr]}</div>
      </div>
      <div style="min-width:40%;text-align:right">
        <select data-skill="${s.id}" class="skillSelect">
          <option value="0"${chosen===0?' selected':''}>Nenhum (0)</option>
          <option value="2"${chosen===2?' selected':''}>Treinado (+2)</option>
          <option value="4"${chosen===4?' selected':''}>Especialista (+4)</option>
        </select>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">Origem: ${originBonus>0? '+'+originBonus : '‚Äî'} ‚Äî Total: <strong>${total>=0? '+'+total : total}</strong></div>
      </div>
    `;
    skillsBox.appendChild(div);
  });

  // listeners
  document.querySelectorAll('.skillSelect').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const id = sel.dataset.skill;
      state.skillLevel[id] = parseInt(sel.value,10) || 0;
      saveLocal(false);
      renderSummary();
    });
  });
}

function renderOriginEffects(){
  const map = ORIGENS[state.origin] || {};
  const keys = Object.keys(map);
  if(keys.length===0){
    originEffects.innerHTML = 'Nenhuma per√≠cia recebe b√¥nus por esta origem.';
    return;
  }
  originEffects.innerHTML = keys.map(k => {
    // find skill label
    const lab = (SKILLS.find(s=>s.id===k)?.label) || k;
    return `${lab}: +${map[k]}`;
  }).join('<br>');
}

function renderSummary(){
  // build summary showing effective skill totals and attributes
  let html = `<div style="display:flex;flex-direction:column;gap:6px">`;
  html += `<div><b>Nome:</b> ${state.name || '‚Äî'}</div>`;
  html += `<div><b>Origem:</b> ${state.origin}</div>`;
  html += `<div style="margin-top:6px"><b>Atributos:</b>`;
  ATTR_KEYS.forEach(k => html += `<div style="font-size:13px">${ATTR_LABELS[k]}: ${state.attrs[k]}</div>`);
  html += `</div>`;
  html += `<div style="margin-top:6px"><b>Per√≠cias (total = escolha + origem):</b>`;
  SKILLS.forEach(s => {
    const chosen = state.skillLevel[s.id] || 0;
    const ob = originSkillBonus(s.id);
    const total = chosen + ob;
    html += `<div style="font-size:13px">${s.label}: escolha ${chosen>0? '+'+chosen : 0 } ${ob? ` + origem ${'+'+ob}` : '' } ‚Üí <strong>${ total>0? '+'+total : total }</strong></div>`;
  });
  html += `</div></div>`;
  summaryDiv.innerHTML = html;
}

/* ========== ATTRIB MUTATIONS ========== */
function incAttr(key){
  const cur = state.attrs[key] || START_ATTR;
  if(cur >= MAX_ATTR) return;
  // check points
  const left = calcPoints();
  if(left <= 0) {
    alert('Sem pontos restantes.');
    return;
  }
  state.attrs[key] = cur + 1;
  saveLocal(false);
  renderAttrs();
  renderSummary();
}

function decAttr(key){
  const cur = state.attrs[key] || START_ATTR;
  if(cur <= MIN_ATTR) return;
  // decreasing below START_ATTR frees point
  state.attrs[key] = cur - 1;
  saveLocal(false);
  renderAttrs();
  renderSummary();
}

/* ========== SAVE / LOAD (local) & IMPORT/EXPORT JSON ========== */
const STORAGE_KEY = 'sistemaZ_ficha_v2';

function saveLocal(announce=true){
  const payload = {
    name: state.name,
    origin: state.origin,
    attrs: state.attrs,
    skillLevel: state.skillLevel,
    equip: document.getElementById('equip').value,
    notes: document.getElementById('notes').value
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  if(announce) alert('Ficha salva localmente.');
}

function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert('Nenhuma ficha local encontrada.'); return; }
  try {
    const d = JSON.parse(raw);
    state.name = d.name || '';
    state.origin = d.origin || 'nenhuma';
    state.attrs = Object.assign({}, state.attrs, d.attrs || {});
    state.skillLevel = Object.assign({}, state.skillLevel, d.skillLevel || {});
    document.getElementById('nome').value = state.name;
    document.getElementById('equip').value = d.equip || '';
    document.getElementById('notes').value = d.notes || '';
    origemSelect.value = state.origin;
    renderSkills();
    renderAttrs();
    renderSummary();
    renderOriginEffects();
    alert('Ficha carregada.');
  } catch(e){ alert('Erro ao carregar ficha local.'); }
}

function exportJSON(){
  const payload = {
    name: state.name,
    origin: state.origin,
    attrs: state.attrs,
    skillLevel: state.skillLevel,
    equip: document.getElementById('equip').value,
    notes: document.getElementById('notes').value,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (state.name || 'ficha') + '.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=> {
    try{
      const d = JSON.parse(reader.result);
      // basic validation
      if(!d.attrs || !d.skillLevel){ alert('JSON inv√°lido (faltam campos).'); return; }
      state.name = d.name || '';
      state.origin = d.origin || 'nenhuma';
      state.attrs = Object.assign({}, state.attrs, d.attrs || {});
      state.skillLevel = Object.assign({}, state.skillLevel, d.skillLevel || {});
      document.getElementById('nome').value = state.name;
      document.getElementById('equip').value = d.equip || '';
      document.getElementById('notes').value = d.notes || '';
      origemSelect.value = state.origin;
      renderSkills();
      renderAttrs();
      renderSummary();
      renderOriginEffects();
      alert('Importa√ß√£o conclu√≠da.');
    }catch(e){
      alert('Erro ao ler JSON: ' + e.message);
    }
  };
  reader.readAsText(file);
}

/* ========== INIT ========== */
document.getElementById('nome').addEventListener('input', e=>{ state.name = e.target.value; saveLocal(false); renderSummary(); });
document.getElementById('equip').addEventListener('input', ()=> saveLocal(false));
document.getElementById('notes').addEventListener('input', ()=> saveLocal(false));

document.getElementById('saveLocal').addEventListener('click', ()=>{ state.name = document.getElementById('nome').value; saveLocal(true); });
document.getElementById('loadLocal').addEventListener('click', loadLocal);

document.getElementById('exportBtn').addEventListener('click', exportJSON);
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (e)=> {
  const f = e.target.files[0]; if(f) importJSONFile(f);
});

origemSelect.addEventListener('change', ()=> {
  state.origin = origemSelect.value;
  saveLocal(false);
  renderSkills();
  renderSummary();
  renderOriginEffects();
});

/* load from storage on start (if any) */
(function boot(){
  // defaults
  resetStateDefaults();
  // try load
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      const d = JSON.parse(raw);
      state.name = d.name || '';
      state.origin = d.origin || 'nenhuma';
      state.attrs = Object.assign({}, state.attrs, d.attrs || {});
      state.skillLevel = Object.assign({}, state.skillLevel, d.skillLevel || {});
      document.getElementById('nome').value = state.name;
      document.getElementById('equip').value = d.equip || '';
      document.getElementById('notes').value = d.notes || '';
    }catch(e){}
  }

  renderOriginOptions();
  renderSkills();
  renderAttrs();
  renderSummary();
  renderOriginEffects();
})();
</script>
</body>
</html>
