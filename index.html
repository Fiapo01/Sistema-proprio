<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ficha — Sistema Z</title>
<style>
  :root{
    --bg:#07070a;
    --panel:#0f1720;
    --muted:#93a1b1;
    --accent:#ef4444;
    --glass:rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg),#04101a);color:#e7eef8;padding:18px}
  /* Força as cores essenciais caso algum script tenha aplicado estilos inline inesperados */
  body, .wrap, .card, label, input, textarea, select, .resultado { color: #e7eef8 !important; }
  .note, .attr .name { color: var(--muted) !important; }
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;color:var(--accent);font-size:20px}
  .note{color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg,var(--panel),#071022);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 24px rgba(0,0,0,0.5)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;margin-top:14px}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type=text], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:90px}
  .attrs{display:flex;gap:8px;margin-top:8px}
  .attr{flex:1;background:var(--glass);padding:10px;border-radius:10px;text-align:center}
  .attr .name{font-size:13px;color:var(--muted)}
  .attr .val{font-size:20px;margin:6px 0}
  .attr .controls{display:flex;justify-content:center;gap:8px}
  .btn{background:var(--accent);border:none;color:white;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#2b3946}
  .skills{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  .skill{background:var(--glass);padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:13px;padding:6px 8px}
  .row{display:flex;gap:8px;align-items:center}
  .resultado{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:10px;color:var(--muted)}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .statusBox .attr{background:rgba(255,255,255,0.05);}
  /* Quebra de página ao imprimir/exportar para PDF */
  .page-break{page-break-before:always;break-before:always;margin-top:24px}
  @media print{.page-break{display:block}} 
  .inventory-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:600px){.inventory-grid{grid-template-columns:1fr}}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  /* Estilo para dropdown no modo escuro */
  select {
    background-color: #111827; /* Fundo escuro */
    color: #f3f4f6; /* Texto claro */
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 5px;
  }

  /* Corrige a cor da lista aberta */
  option {
    background-color: #111827;
    color: #f3f4f6;
  }

  /* Efeito hover nas opções */
  option:hover {
    background-color: #1f2937;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>🧟 Sistema Z — Ficha</h1>
    </header>

    <!-- STATUS -->
    <div class="card statusBox" style="margin-top:14px;">
      <label>Status</label>
      <div class="attrs">
        <div class="attr">
          <div class="name">Vida</div>
          <div class="val"><span id="vidaAtual">--</span> / <span id="vidaMax">--</span></div>
          <div class="controls">
            <button class="btn small" id="vidaMenos">-</button>
            <button class="btn small" id="vidaMais">+</button>
          </div>
        </div>
        <div class="attr">
          <div class="name">Sanidade</div>
          <div class="val"><span id="sanAtual">--</span> / <span id="sanMax">--</span></div>
          <div class="controls">
            <button class="btn small" id="sanMenos">-</button>
            <button class="btn small" id="sanMais">+</button>
          </div>
        </div>
        <div class="attr">
          <div class="name">Defesa</div>
          <div class="val" id="defVal">--</div>
        </div>
      </div>
      <div id="statusMsg" class="note" style="margin-top:8px;text-align:center;"></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div style="flex:1">
          <label>Nome do Personagem</label>
          <input id="nome" type="text" placeholder="Ex: Ana Silva">
        </div>
        <div style="width:260px">
          <label>Origem</label>
          <select id="origem"></select>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="saveBtn">💾 Salvar Ficha</button>
          <button class="btn secondary" id="loadBtn">📂 Carregar Ficha</button>
          <input id="loadInput" type="file" accept=".json,application/json" style="display:none" />
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <label>Atributos</label>
          <div class="attrs" id="attrsBox"></div>
          <div class="note" style="margin-top:10px">Pontos restantes: <strong id="pointsLeft">5</strong></div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>Perícias</label>
          <div class="skills" id="skillsBox"></div>
        </div>

        <!-- Equipamento removido (migrado para a página de Inventário no PDF) -->
      </div>

      <div>
        <div class="card">
          <label>Resumo</label>
          <div id="summary" class="resultado"></div>
        </div>
    
        </div>
      </div>
    </div>


    <!-- Página separada para Inventário (será exportada como nova página no PDF) -->
    <div class="page-break">
      <div class="card">
        <h2 style="margin-top:0;color:var(--accent)">Inventário</h2>
        <div class="inventory-grid">
          <div>
            <label>Armas</label>
            <!-- Controles de seleção de armas e indicador de carga serão inseridos aqui -->
            <div id="weaponsControls" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px">
              <div style="display:flex;gap:8px;align-items:center">
                <select id="selectArma" style="flex:1;padding:6px;border-radius:6px;background:transparent;color:inherit"></select>
                <button id="addArmaBtn" class="btn small">Adicionar Arma</button>
              </div>
              <p id="cargaInfo" style="margin:0;font-weight:bold"></p>
              <ul id="listaArmas" style="list-style:none;padding:0;margin:0"></ul>
            </div>
            <textarea id="inventoryWeapons" style="min-height:400px"></textarea>
          </div>
          <div>
            <label>Geral</label>
            <textarea id="inventoryGeneral" style="min-height:400px"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const MAX_ATTR=4,MIN_ATTR=0,START_ATTR=1,POINT_POOL=5;
const ATTR_KEYS=['forca','agilidade','vigor','intelecto','presenca'];
const ATTR_LABELS={forca:'Força',agilidade:'Agilidade',vigor:'Vigor',intelecto:'Intelecto',presenca:'Presença'};

// === PERÍCIAS ===
const SKILLS=[
  {id:'atletismo',label:'Atletismo',attr:'agilidade'},
  {id:'acrobacia',label:'Acrobacia',attr:'forca'},
  {id:'luta',label:'Luta',attr:'forca'},
  {id:'furtividade',label:'Furtividade',attr:'agilidade'},
  {id:'pontaria',label:'Pontaria',attr:'agilidade'},
  {id:'reflexos',label:'Reflexos',attr:'agilidade'},
  {id:'resistencia',label:'Resistência',attr:'vigor'},
  {id:'sobrevivencia',label:'Sobrevivência',attr:'vigor'},
  {id:'medicina',label:'Medicina',attr:'intelecto'},
  {id:'investigacao',label:'Investigação',attr:'intelecto'},
  {id:'engenharia',label:'Engenharia',attr:'intelecto'},
  {id:'enganacao',label:'Enganação',attr:'presenca'},
  {id:'intimidacao',label:'Intimidação',attr:'presenca'},
  {id:'diplomacia',label:'Diplomacia',attr:'presenca'},
  {id:'vontade',label:'Vontade',attr:'presenca'},
  {id:'pilotagem',label:'Pilotagem',attr:'agilidade'},
  {id:'percepcao',label:'Percepção',attr:'presenca'},
  {id:'crime',label:'Crime',attr:'intelecto'},
  {id:'religiao',label:'Religião',attr:'presenca'},
  {id:'adetramento',label:'Adestramento',attr:'presenca'}
];

const ORIGENS={
  'nenhuma':{},
  'militar':{'pontaria':4,'sobrevivencia':2},
  'cientista':{'investigacao':2,'medicina':4},
  'policial':{'investigacao':2,'pontaria':4},
  'criminoso':{'furtividade':2,'crime':4},
  'religioso':{'vontade':4,'diplomacia':2},
  'tecnico':{'engenharia':4,'enganacao':2},
  'explorador':{'sobrevivencia':4,'atletismo':2},
  'lutador':{'luta':4,'resistencia':2},
  'medico':{'medicina':4,'diplomacia':2},
  'motorista':{'pilotagem':4,'percepcao':2},
  'religioso':{'religiao':4,'diplomacia':2},
  'investigador':{'investigacao':4,'intimidacao':2},
  'amigo dos animais':{'adestramento':4,'diplomacia':2},
  'ator':{'enganacao':4,'':2}
};

let state={name:'',origin:'nenhuma',attrs:{},skillLevel:{},vidaAtual:0,sanAtual:0,inventario:{armas:[],geral:""}};

ATTR_KEYS.forEach(k=>state.attrs[k]=START_ATTR);
SKILLS.forEach(s=>state.skillLevel[s.id]=0);

function calcPoints(){
  const spentAbove=Object.values(state.attrs).filter(v=>v>START_ATTR).reduce((a,b)=>a+b-START_ATTR,0);
  const freedBelow=Object.values(state.attrs).filter(v=>v<START_ATTR).reduce((a,b)=>a+(START_ATTR-b),0);
  return Math.max(0,POINT_POOL+freedBelow-spentAbove);
}
function originSkillBonus(id){return ORIGENS[state.origin]?.[id]||0;}
function totalSkillBonus(id){return (state.skillLevel[id]||0)+originSkillBonus(id);}

function calcStatus(){
  const vidaMax=10+state.attrs.vigor*4;
  const sanMax=8+state.attrs.presenca*2;
  const def=10+state.attrs.forca*3;
  if(state.vidaAtual>vidaMax)state.vidaAtual=vidaMax;
  if(state.sanAtual>sanMax)state.sanAtual=sanMax;
  document.getElementById('vidaMax').textContent=vidaMax;
  document.getElementById('sanMax').textContent=sanMax;
  document.getElementById('defVal').textContent=def;
  document.getElementById('vidaAtual').textContent=state.vidaAtual;
  document.getElementById('sanAtual').textContent=state.sanAtual;
  let msg='';
  if(state.vidaAtual<=0)msg='💀 Você está morto.';
  else if(state.sanAtual<=0)msg='🧠 Você enlouqueceu.';
  document.getElementById('statusMsg').textContent=msg;
}

function renderAttrs(){
  const box=document.getElementById('attrsBox'); box.innerHTML='';
  ATTR_KEYS.forEach(k=>{
    const div=document.createElement('div');
    div.className='attr';
    div.innerHTML=`
      <div class="name">${ATTR_LABELS[k]}</div>
      <div class="val">${state.attrs[k]}</div>
      <div class="controls">
        <button class="btn small" onclick="changeAttr('${k}',-1)">-</button>
        <button class="btn small" onclick="changeAttr('${k}',1)">+</button>
      </div>`;
    box.appendChild(div);
  });
  document.getElementById('pointsLeft').textContent=calcPoints();
  calcStatus();
  renderSummary();
  // atualiza limite/carga do inventário sempre que atributos mudam
  if(typeof atualizarCarga === 'function') atualizarCarga();
}
function changeAttr(k,delta){
  const val=state.attrs[k];
  if(delta>0 && calcPoints()<=0)return;
  state.attrs[k]=Math.min(MAX_ATTR,Math.max(MIN_ATTR,val+delta));
  renderAttrs();
}

function renderSkills(){
  const box=document.getElementById('skillsBox'); box.innerHTML='';
  SKILLS.forEach(s=>{
    const chosen=state.skillLevel[s.id]; const originBonus=originSkillBonus(s.id); const total=chosen+originBonus;
    const div=document.createElement('div');
    div.className='skill';
    div.innerHTML=`
      <div><b>${s.label}</b><div class="note">${ATTR_LABELS[s.attr]}</div></div>
      <div>
        <select onchange="setSkill('${s.id}',this.value)">
          <option value="0"${chosen==0?' selected':''}>0</option>
          <option value="2"${chosen==2?' selected':''}>+2</option>
          <option value="4"${chosen==4?' selected':''}>+4</option>
        </select>
        <div class="note">Origem: ${originBonus>0? '+'+originBonus:'—'} | Total: ${total>=0? '+'+total:total}</div>
      </div>`;
    box.appendChild(div);
  });
}
function setSkill(id,val){state.skillLevel[id]=parseInt(val)||0; renderSkills(); renderSummary();}

function renderSummary(){
  let html=`<div><b>${state.name||'Sem nome'}</b>`;
  html += `<div class="note">Origem: ${state.origin? (state.origin.charAt(0).toUpperCase()+state.origin.slice(1)) : 'Nenhuma'}</div></div>`;
  ATTR_KEYS.forEach(k=>html+=`<div>${ATTR_LABELS[k]}: ${state.attrs[k]}</div>`);

  // Lista as perícias que estão treinadas (bônus de origem ou escolha manual)
  const trained = SKILLS.filter(s => totalSkillBonus(s.id) > 0);
  if(trained.length){
    html += `<div style="margin-top:8px"><b>Perícias treinadas</b></div>`;
    trained.forEach(s=>{
      const chosen = state.skillLevel[s.id] || 0;
      const originB = originSkillBonus(s.id) || 0;
      const total = chosen + originB;
      const notes = [];
      if(chosen>0) notes.push('manual +' + chosen);
      if(originB>0) notes.push('origem +' + originB);
      html += `<div>${s.label}: ${total>=0? '+'+total:total} <span class="note">(${notes.join(' | ')})</span></div>`;
    });
  }

  document.getElementById('summary').innerHTML=html;
}

// Função adicional: atualiza o resumo em um elemento alternativo `#resumo` se existir
function atualizarResumo(){
  const resumoDiv = document.getElementById('resumo') || document.getElementById('summary');
  if(!resumoDiv) return;
  // Usa state e chaves internas (atributos em lower-case)
  const s = state || {};
  const a = s.attrs || {};
  const nome = s.name || 'Sem nome';
  const origemLabel = s.origin? (s.origin.charAt(0).toUpperCase()+s.origin.slice(1)) : 'Nenhuma';
  resumoDiv.innerHTML = `
    <strong>${escapeHtml(nome)}</strong>
    <div class="note">Origem: ${escapeHtml(origemLabel)}</div>
    <div>Força: ${a.forca}</div>
    <div>Agilidade: ${a.agilidade}</div>
    <div>Vigor: ${a.vigor}</div>
    <div>Intelecto: ${a.intelecto}</div>
    <div>Presença: ${a.presenca}</div>
  `;
}

// liga atualizações em tempo real ao campo nome e origem (já existe listener para nome, reaproveitamos)
const nomeEl = document.getElementById('nome');
if(nomeEl){ nomeEl.addEventListener('input', (e)=>{ state.name = e.target.value; renderSummary(); atualizarResumo(); }); }
const origemEl = document.getElementById('origem');
if(origemEl){ origemEl.addEventListener('change', ()=>{ state.origin = origemEl.value; renderSkills(); calcStatus(); renderSummary(); atualizarResumo(); }); }

// liga atualizações também aos atributos (atributos são as chaves em ATTR_KEYS)
ATTR_KEYS.forEach(k=>{
  // Os controles de atributo no UI são renderizados dinamicamente; usamos delegação simples via renderAttrs que chama atualizarCarga
  // Se existir um input com id `attr-<Label>` podemos ligar, mas a UI atual não cria inputs com esses ids; então chamamos atualizarResumo() em renderAttrs()
});

// garante que o resumo inicial apareça
document.addEventListener('DOMContentLoaded', ()=>{ atualizarResumo(); });

function renderOriginOptions(){
  const sel=document.getElementById('origem'); sel.innerHTML='';
  for(const k in ORIGENS){const opt=document.createElement('option'); opt.value=k; opt.textContent=k.charAt(0).toUpperCase()+k.slice(1); sel.appendChild(opt);}
  sel.value=state.origin;
  sel.onchange=()=>{state.origin=sel.value; renderSkills(); calcStatus(); renderSummary();}
}

// === Botões de Vida e Sanidade ===
document.getElementById('vidaMais').onclick=()=>{state.vidaAtual++;calcStatus();}
document.getElementById('vidaMenos').onclick=()=>{state.vidaAtual--;calcStatus();}
document.getElementById('sanMais').onclick=()=>{state.sanAtual++;calcStatus();}
document.getElementById('sanMenos').onclick=()=>{state.sanAtual--;calcStatus();}

// === Inicialização ===
function init(){
  state.vidaAtual=10+state.attrs.vigor*4;
  state.sanAtual=10+state.attrs.presenca*3;
  // se o campo de nome já estiver preenchido no DOM (ex: carregado por outra parte), inicializa state.name
  const nomeInput = document.getElementById('nome');
  if(nomeInput && nomeInput.value) state.name = nomeInput.value;
  renderOriginOptions();
  renderAttrs();
  renderSkills();
  renderSummary();
  // garante que inventario exista e sincroniza UI de armas
  state.inventario = state.inventario || {armas:[],geral: ''};
  renderListaArmas();
  atualizarCarga();
}
init();
// Atualiza state.name enquanto o usuário digita no campo "nome"
document.getElementById('nome').addEventListener('input', (e)=>{ state.name = e.target.value; renderSummary(); });
</script>
<!-- html2pdf CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  // Exportar conteúdo da ficha como PDF (constrói um HTML simples contendo só resumo + inventário)
  const exportBtnEl = document.getElementById('exportBtn');
  if(exportBtnEl) exportBtnEl.addEventListener('click', ()=>{
    if(typeof html2pdf === 'undefined'){
      alert('Não foi possível carregar a biblioteca de exportação (html2pdf). Verifique sua conexão de internet e recarregue a página.');
      return;
    }

    const name = (document.getElementById('nome').value || 'Sem nome');
    const originLabel = state.origin ? (state.origin.charAt(0).toUpperCase()+state.origin.slice(1)) : 'Nenhuma';
    const vidaMax = 10 + (state.attrs?.vigor||0)*4;
    const sanMax = 8 + (state.attrs?.presenca||0)*2;

    const summaryHtml = document.getElementById('summary')?.innerHTML || '';
    const weaponsText = document.getElementById('inventoryWeapons')?.value || '';
    const generalText = document.getElementById('inventoryGeneral')?.value || '';

    // Cria container limpo
    const temp = document.createElement('div');
    temp.style.width = '792px';
    temp.style.boxSizing = 'border-box';
    temp.style.fontFamily = 'Arial, Helvetica, sans-serif';
    temp.style.color = '#000';
    temp.style.background = '#fff';
    temp.style.padding = '20px';

    // Cabeçalho com nome e origem
    const h = document.createElement('div');
    const h1 = document.createElement('h1'); h1.textContent = name; h1.style.margin='0 0 6px 0'; h1.style.color='#111';
    const orig = document.createElement('div'); orig.textContent = 'Origem: ' + originLabel; orig.style.marginBottom='8px'; orig.className='note';
    h.appendChild(h1); h.appendChild(orig);
    temp.appendChild(h);

    // Status
    const status = document.createElement('div'); status.style.marginBottom='10px';
    status.innerHTML = `<strong>Status</strong><div>Vida: ${state.vidaAtual} / ${vidaMax}</div><div>Sanidade: ${state.sanAtual} / ${sanMax}</div>`;
    temp.appendChild(status);

    // Resumo (usa o HTML gerado pelo app)
    const sumWrap = document.createElement('div'); sumWrap.innerHTML = summaryHtml; temp.appendChild(sumWrap);

    // Quebra de página e Inventário
    const pageBreak = document.createElement('div'); pageBreak.style.pageBreakBefore='always'; pageBreak.style.breakBefore='always';
    temp.appendChild(pageBreak);

    const invWrap = document.createElement('div'); invWrap.style.padding='20px';
    const invTitle = document.createElement('h2'); invTitle.textContent = 'Inventário'; invTitle.style.marginTop='0'; invWrap.appendChild(invTitle);
    const grid = document.createElement('div'); grid.style.display='flex'; grid.style.gap='12px';
    const col1 = document.createElement('div'); col1.style.flex='1'; const col2 = document.createElement('div'); col2.style.flex='1';
    const wTitle = document.createElement('h3'); wTitle.textContent='Armas'; wTitle.style.marginTop='0';
    const gTitle = document.createElement('h3'); gTitle.textContent='Geral'; gTitle.style.marginTop='0';
    const wPre = document.createElement('pre'); wPre.textContent = weaponsText; wPre.style.whiteSpace='pre-wrap'; wPre.style.wordWrap='break-word';
    const gPre = document.createElement('pre'); gPre.textContent = generalText; gPre.style.whiteSpace='pre-wrap'; gPre.style.wordWrap='break-word';
    col1.appendChild(wTitle); col1.appendChild(wPre); col2.appendChild(gTitle); col2.appendChild(gPre); grid.appendChild(col1); grid.appendChild(col2); invWrap.appendChild(grid);
    temp.appendChild(invWrap);

    // Anexa e gera PDF
    temp.style.position='fixed'; temp.style.left='10px'; temp.style.top='10px'; temp.style.zIndex=99999; document.body.appendChild(temp);

    const opt = {
      margin:       0.5,
      filename:     (document.getElementById('nome').value || 'ficha') + '.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(temp).save().then(()=>{ temp.remove(); }).catch((err)=>{
      // limpeza simples: remove container temporário e avisa o usuário
      try{ temp.remove(); }catch(e){}
      console.error('Erro ao gerar PDF com html2pdf:', err);
      alert('Erro ao gerar PDF: '+(err?.message||err));
    });
  });
  // Botão de fallback: abre nova janela com conteúdo limpo e chama print() (implementação segura)
  const printBtnEl = document.getElementById('printBtn');
  if(printBtnEl) printBtnEl.addEventListener('click', ()=>{
    const name = (document.getElementById('nome').value || 'Sem nome');
    const originLabel = state.origin ? (state.origin.charAt(0).toUpperCase()+state.origin.slice(1)) : 'Nenhuma';
    const vidaMax = 10 + (state.attrs?.vigor||0)*4;
    const sanMax = 8 + (state.attrs?.presenca||0)*2;
    const summaryHtml = (document.getElementById('summary')?.innerHTML || '').replace(/<\/(script)/ig, '<\\/script');
    const weaponsText = (document.getElementById('inventoryWeapons')?.value || '');
    const generalText = (document.getElementById('inventoryGeneral')?.value || '');
    try{
      const win = window.open('', '_blank');
      const css = '<style>body{font-family:Arial,Helvetica,sans-serif;color:#111;padding:20px} h1{margin:0 0 6px 0} h2{margin-top:0} pre{white-space:pre-wrap;word-wrap:break-word}</style>';
      let html = '<!doctype html><html><head><meta charset="utf-8">'+css+'</head><body>';
      html += '<h1>'+escapeHtml(name)+'</h1>';
      html += '<div>Origem: '+escapeHtml(originLabel)+'</div>';
      html += '<div style="margin-top:8px"><strong>Status</strong><div>Vida: '+state.vidaAtual+' / '+vidaMax+'</div><div>Sanidade: '+state.sanAtual+' / '+sanMax+'</div></div>';
      html += '<div style="margin-top:12px">'+summaryHtml+'</div><hr><h2>Inventário</h2><div style="display:flex;gap:12px"><div style="flex:1"><h3>Armas</h3><pre>'+escapeHtml(weaponsText)+'</pre></div><div style="flex:1"><h3>Geral</h3><pre>'+escapeHtml(generalText)+'</pre></div></div>';
      html += '</body></html>';
      win.document.open(); win.document.write(html); win.document.close(); win.focus(); setTimeout(()=>{ try{ win.print(); }catch(e){console.error(e);} },500);
    }catch(e){ console.error(e); alert('Falha ao abrir janela de impressão: '+(e.message||e)); }
  });

  // utilitário simples para escapar texto antes de inserir em HTML
  function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
</script>
<script>
// Remove nós de texto ou elementos que contenham trechos de código deixados acidentalmente
function removeStrayCodeFragments(){
  const body = document.body;
  if(!body) return;
  const patterns = [/doc\.close\(/i,/Erro ao gerar PDF/i,/Falha ao chamar print/i,/html2pdf/i,/temp\.remove\(\)/i];
  const toRemove = [];
  // inspeciona nós filhos do body e marca para remoção quando o texto combinar
  body.childNodes.forEach(node=>{
    try{
      const text = (node.textContent||'').trim();
      if(!text) return;
      for(const p of patterns){ if(p.test(text)){ toRemove.push(node); break; } }
    }catch(e){/* ignore */}
  });
  toRemove.forEach(n=>n.remove());
}
document.addEventListener('DOMContentLoaded', ()=>{ removeStrayCodeFragments(); });
</script>
<script>
// Limpeza específica: remove nós que contenham o trecho problemático exato
document.addEventListener('DOMContentLoaded', ()=>{
  const needle = "win.document.open(); win.document.write(html); win.document.close(); win.focus(); setTimeout(()=>{ try{ win.print(); }catch(e){console.error(e);} },500);";
  document.body.childNodes.forEach(n=>{
    try{ if(n.textContent && n.textContent.indexOf(needle)!==-1) n.remove(); }catch(e){}
  });
});
// Função utilitária: converte o objeto ficha para JSON e inicia download
function downloadJson(obj, filename){
  try{
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename || 'ficha.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }catch(e){ console.error('Erro ao gerar download JSON', e); alert('Erro ao gerar arquivo JSON: '+(e.message||e)); }
}

document.getElementById("saveBtn").addEventListener("click", async () => {
  const cargaTotal = (state.inventario.armas || []).reduce((t,a)=>t+(a.peso||0),0);
  const limiteCarga = 2 + (state?.attrs?.forca || 0);

  const ficha = {
    nome: state.name || "Sem nome",
    origem: state.origin,
    atributos: state.attrs,
    pericias: state.skillLevel,
    vidaAtual: state.vidaAtual,
    sanAtual: state.sanAtual,
    inventario: {
      // salva lista estruturada de armas
      armas: (state.inventario.armas || []).map(a=>{
        const item = { nome: a.nome, peso: a.peso };
        if(a.dano && a.dano !== '-') item.dano = a.dano;
        return item;
      }),
      carga_total: cargaTotal,
      limite_carga: limiteCarga,
      // mantém também o texto livre para compatibilidade
      geral: state.inventario?.geral || document.getElementById('inventoryGeneral')?.value || "",
      armas_texto: document.getElementById('inventoryWeapons')?.value || ""
    }
  };

  // Baixa localmente o arquivo JSON (sempre)
  downloadJson(ficha, (document.getElementById('nome').value || 'ficha') + '.json');

  // Também tenta enviar ao servidor (se houver endpoint)
  try {
    const res = await fetch("/api/salvar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(ficha)
    });
    // se o servidor responder com JSON, mostra feedback
    try{
      const data = await res.json();
      if (data.ok) console.log('Ficha enviada ao servidor com sucesso');
      else console.warn('Servidor retornou erro ao salvar ficha', data);
    }catch(e){ console.warn('Resposta do servidor não está em JSON ou sem corpo'); }
  } catch (err) {
    console.info('Não foi possível enviar ao servidor (opcional):', err.message || err);
  }
});

// Handler: botão e input para carregar arquivo JSON
document.getElementById('loadBtn').addEventListener('click', ()=> document.getElementById('loadInput').click());
document.getElementById('loadInput').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      applyFichaObject(obj);
      alert('✅ Ficha carregada com sucesso!');
    }catch(err){ console.error(err); alert('Arquivo inválido: ' + (err.message||err)); }
    // limpa para permitir re-upload do mesmo arquivo
    e.target.value='';
  };
  reader.onerror = ()=>{ alert('Erro ao ler arquivo'); e.target.value=''; };
  reader.readAsText(f, 'utf-8');
});

function applyFichaObject(obj){
  // Faz validações e aplica ao state e aos campos da UI
  if(!obj) return;
  if(typeof obj.nome === 'string'){
    state.name = obj.nome; document.getElementById('nome').value = obj.nome;
  }
  if(typeof obj.origem === 'string' && ORIGENS.hasOwnProperty(obj.origem)){
    state.origin = obj.origem; document.getElementById('origem').value = obj.origem;
  }
  if(obj.atributos && typeof obj.atributos === 'object'){
    ATTR_KEYS.forEach(k=>{ if(typeof obj.atributos[k] === 'number') state.attrs[k]=Math.max(MIN_ATTR, Math.min(MAX_ATTR, obj.atributos[k])); });
  }
  if(obj.pericias && typeof obj.pericias === 'object'){
    SKILLS.forEach(s=>{ if(typeof obj.pericias[s.id] === 'number') state.skillLevel[s.id]=obj.pericias[s.id]; });
  }
  if(typeof obj.vidaAtual === 'number') state.vidaAtual = obj.vidaAtual;
  if(typeof obj.sanAtual === 'number') state.sanAtual = obj.sanAtual;
  if(obj.inventario && typeof obj.inventario === 'object'){
    // Inventário pode vir no formato estruturado (array de armas) ou texto
    if(Array.isArray(obj.inventario.armas)){
      state.inventario.armas = obj.inventario.armas.map(a=>({ nome: a.nome, peso: a.peso||1, dano: a.dano }));
      // atualiza textarea texto e lista
      document.getElementById('inventoryWeapons').value = (state.inventario.armas||[]).map(a=>a.nome + (a.peso?` (Peso ${a.peso})`: '')).join('\n');
      renderListaArmas();
      atualizarCarga();
    }else if(typeof obj.inventario.armas === 'string'){
      document.getElementById('inventoryWeapons').value = obj.inventario.armas;
      // tenta reconstruir a lista a partir do texto
      syncArmasFromTextarea();
    }
    if(typeof obj.inventario.geral === 'string') document.getElementById('inventoryGeneral').value = obj.inventario.geral;
  }
  // Re-renderiza UI dependente do state
  renderOriginOptions();
  renderAttrs();
  renderSkills();
  renderSummary();
  calcStatus();
}

</script>
<script>
// === Inventário de Armas com limite de carga ===
const armasDisponiveis = [
  { nome: "Pistola", dano: "1d6", peso: 1 },
  { nome: "Espingarda", dano: "2d6", peso: 2 },
  { nome: "Faca", dano: "1d4", peso: 0 },
  { nome: "Machado", dano: "1d8", peso: 2 },
  { nome: "Revólver", dano: "1d6", peso: 1 },
  { nome: "Metralhadora", dano: "2d6", peso: 3 },
  { nome: "Arco e Flecha", dano: "1d6", peso: 2 },
  { nome: "Besta", dano: "1d8", peso: 3 },
  { nome: "Rifle de Precisão", dano: "2d8", peso: 3 },
  { nome: "Mochila", dano: "-", peso: -2 },
  { nome: "Kit Médico", dano: "-", peso: 1 },
  { nome: "Corda (10m)", dano: "-", peso: 2 },
  { nome: "Lanterna", dano: "-", peso: 1 },
  { nome: "Canivete", dano: "1d4", peso: 0 },
  { nome: "Granada", dano: "3d6", peso: 2 },
  { nome: "Coquetel Molotov", dano: "2d6", peso: 1 },
  { nome: "Spray de Pimenta", dano: "1d4", peso: 0 },
  { nome: "Escudo Improvisado", dano: "-", peso: 2 },
  { nome: "Balas (Pacote)", dano: "-", peso: 1 }
];

const selectArmaEl = document.getElementById('selectArma');
const addArmaBtn = document.getElementById('addArmaBtn');
const listaArmasEl = document.getElementById('listaArmas');
const cargaInfoEl = document.getElementById('cargaInfo');
const inventoryWeaponsTA = document.getElementById('inventoryWeapons');

// armas agora são armazenadas em state.inventario.armas (array de objetos {nome,peso,dano})
// let armasSelecionadas = [];

function initArmasControls(){
  // preenche select
  selectArmaEl.innerHTML = '';
  armasDisponiveis.forEach(a => {
    const opt = document.createElement('option'); opt.value = a.nome;
    const danoParte = (a.dano && a.dano !== '-') ? `Dano ${a.dano}, ` : '';
    opt.textContent = `${a.nome} (${danoParte}Peso ${a.peso})`;
    selectArmaEl.appendChild(opt);
  });

  addArmaBtn.onclick = () => {
    const armaNome = selectArmaEl.value;
    const arma = armasDisponiveis.find(a => a.nome === armaNome);
    if(!arma) return;
    state.inventario.armas.push(arma);
    renderListaArmas();
    atualizarCarga();
    syncArmasToTextarea();
  };
}

function renderListaArmas(){
  listaArmasEl.innerHTML = '';
  (state.inventario.armas||[]).forEach((arma, idx) => {
    const li = document.createElement('li');
    li.style.padding = '6px 0';
  const danoParteLi = (arma.dano && arma.dano !== '-') ? `Dano ${arma.dano}, ` : '';
  li.textContent = `${arma.nome} (${danoParteLi}Peso ${arma.peso})`;
    const btn = document.createElement('button'); btn.textContent = '❌'; btn.style.marginLeft='10px'; btn.className='btn small';
  btn.onclick = () => { state.inventario.armas.splice(idx,1); renderListaArmas(); atualizarCarga(); syncArmasToTextarea(); };
    li.appendChild(btn);
    listaArmasEl.appendChild(li);
  });
}

function atualizarCarga(){
  const forca = state?.attrs?.forca || 0;
  const limite = 2 + forca;
  const carga = (state.inventario.armas||[]).reduce((t,a)=>t+(a.peso||0),0);
  cargaInfoEl.textContent = `Carga Total: ${carga}/${limite}`;
  cargaInfoEl.style.color = carga > limite ? "#ff5555" : "#a0ffa0";
}

function syncArmasToTextarea(){
  // escreve as armas selecionadas no textarea de armas (uma por linha)
  inventoryWeaponsTA.value = (state.inventario.armas||[]).map(a=>{
    const danoTxt = (a.dano && a.dano !== '-') ? ` (Dano ${a.dano})` : '';
    const pesoTxt = (typeof a.peso !== 'undefined') ? ` (Peso ${a.peso})` : '';
    // prefer mostrar dano e peso adequadamente
    return a.nome + (danoTxt ? danoTxt : pesoTxt);
  }).join('\n');
}

function syncArmasFromTextarea(){
  // tenta reconstruir armasSelecionadas a partir do textarea (útil ao carregar JSON)
  const lines = (inventoryWeaponsTA.value||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const found = [];
  lines.forEach(line=>{
    // procura por nome de arma no início da linha
    for(const a of armasDisponiveis){ if(line.indexOf(a.nome)===0){ found.push(a); break; } }
  });
  state.inventario.armas = found;
  renderListaArmas();
  atualizarCarga();
}

// Inicialização após DOM
document.addEventListener('DOMContentLoaded', ()=>{
  initArmasControls();
  // se o textarea já tem conteúdo (ex: carregado por JSON), sincroniza
  syncArmasFromTextarea();
  const invGen = document.getElementById('inventoryGeneral');
  if(invGen){ invGen.addEventListener('input', (e)=>{ state.inventario.geral = e.target.value; }); }
});

// expõe a função para ser chamada em renderAttrs
window.atualizarCarga = atualizarCarga;
// expõe para applyFichaObject chamar
window.syncArmasFromTextarea = syncArmasFromTextarea;
</script>
</body>
</html>
